<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style_css.css">
  <link rel="stylesheet" href="css/songgi-main-navbar.css">
  <title>Songgi - Employees</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/employees.css">
</head>

<body>
  <nav class="songgi-main-navbar">
    <div class="songgi-nav-left-section">
      <div class="songgi-app-branding">
        <div class="songgi-brand-title">Songgi</div>
      </div>
      <div class="songgi-balance-display" id="songgiBalanceToggle">
        <img class="songgi-balance-placeholder-text" src="img/account.png" width="20px">&nbsp;
        <span class="songgi-balance-placeholder-text">Super Admin</span>
      </div>
    </div>

    <div class="songgi-nav-right-section">
      <div class="songgi-nav-icon-btn" id="songgiNotificationCenter">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
          <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
        <div class="songgi-notification-counter">5</div>
      </div>
    </div>
  </nav>

  <!-- Employees Container -->
  <div class="employees-container">
    <!-- Add/Edit Form -->
    <!-- Add/Edit Form -->
    <div class="employee-form">
      <div class="form-row">
        <input type="text" id="employeeNameInput" placeholder="Enter employee name...">
        <input type="text" id="employeeMobileInput" placeholder="Enter mobile number...">
      </div>
      <div class="form-row">
        <input type="text" id="employeeAddressInput" placeholder="Enter address...">
        <select id="employeeStatusInput">
          <option value="1">Active</option>
          <option value="0">Inactive</option>
        </select>
        <button id="saveBtn" onclick="saveEmployee()">
          <i class="fas fa-plus"></i>Add Employee
        </button>
      </div>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
      <div class="total-count" id="totalCount">Total Employees: 0</div>
      <input type="text" class="search-box" placeholder="Search employees..." id="searchInput"
        onkeyup="searchEmployees()">
    </div>

    <!-- Data Table -->
    <div class="table-container">
      <table class="employee-table">
        <thead>
          <tr>
            <th style="width: 60px;">ID</th>
            <th>Employee Name</th>
            <th>Number</th>
            <th style="width: 100px;">Actions</th>
          </tr>
        </thead>
        <tbody id="employeeTableBody">
          <!-- Dynamic Rows -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Employee Details Modal -->
  <div id="employeeModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 class="modal-title">Employee Details</h2>
      <div class="modal-details" id="modalDetails">
        <!-- Details will be populated here -->
      </div>
      <div class="modal-actions">
        <button class="modal-btn edit" id="modalEditBtn">Edit</button>
        <button class="modal-btn delete" id="modalDeleteBtn">Delete</button>
      </div>
    </div>
  </div>

  <!-- Navigation Bar -->
  <div class="navbar">
    <div class="nav-item active" data-page="home">
      <i class="nav-icon fas fa-home"></i>
    </div>

    <div class="nav-item" data-page="history">
      <i class="nav-icon fas fa-chart-bar"></i>
    </div>

    <div class="nav-item" data-page="profile">
      <i class="nav-icon fas fa-user"></i>
    </div>
  </div>
  <script>
    let employees = [];
    let currentEmployeeId = null;

    async function fetchEmployees() {
      try {
        const res = await fetch('API/employees.php');
        employees = await res.json();
        renderTable(employees);
      } catch (error) {
        console.error('Error fetching employees:', error);
      }
    }

    async function saveEmployee() {
      const nameInput = document.getElementById('employeeNameInput');
      const mobileInput = document.getElementById('employeeMobileInput');
      const addressInput = document.getElementById('employeeAddressInput');
      const statusInput = document.getElementById('employeeStatusInput');

      const name = nameInput.value.trim();
      const mobile_no = mobileInput.value.trim();
      const address = addressInput.value.trim();
      const is_active = parseInt(statusInput.value);

      if (!name || !mobile_no) {
        alert('Please enter employee name and mobile number');
        return;
      }

      try {
        const isEditing = window.editingEmployeeId !== undefined;
        const url = 'API/employees.php';
        const method = isEditing ? 'PUT' : 'POST';
        const body = isEditing ?
          JSON.stringify({ id: window.editingEmployeeId, name, mobile_no, address, is_active }) :
          JSON.stringify({ name, mobile_no, address, is_active });

        await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: body
        });

        // Clear inputs and reset form
        nameInput.value = "";
        mobileInput.value = "";
        addressInput.value = "";
        statusInput.value = "1";

        // Reset button text if we were editing
        if (isEditing) {
          document.getElementById('saveBtn').innerHTML = '<i class="fas fa-plus"></i> Add Employee';
          window.editingEmployeeId = undefined;
        }

        // Refresh the list
        fetchEmployees();
      } catch (error) {
        console.error('Error saving employee:', error);
      }
    }

    function viewEmployee(id) {
      const employee = employees.find(e => e.id == id);
      if (!employee) return;

      currentEmployeeId = id;

      // Use the existing employees data instead of making another API call
      const employeeDetails = employee;

      // Get role name based on role_id
      let roleName = "Unknown";
      switch (employeeDetails.role_id) {
        case 1: roleName = "Admin"; break;
        case 2: roleName = "Manager"; break;
        case 3: roleName = "Staff"; break;
      }

      // Populate modal with details
      const modalDetails = document.getElementById('modalDetails');
      modalDetails.innerHTML = `
    <div class="detail-row">
      <div class="detail-label">Name:</div>
      <div class="detail-value">${employeeDetails.name}</div>
    </div>
    <div class="detail-row">
      <div class="detail-label">Mobile:</div>
      <div class="detail-value">${employeeDetails.mobile_no || 'N/A'}</div>
    </div>
    <div class="detail-row">
      <div class="detail-label">Address:</div>
      <div class="detail-value">${employeeDetails.address || 'N/A'}</div>
    </div>
    <div class="detail-row">
      <div class="detail-label">Status:</div>
      <div class="detail-value">${employeeDetails.is_active == 1 ? 'Active' : 'Inactive'}</div>
    </div>
    <div class="detail-row">
      <div class="detail-label">Created:</div>
      <div class="detail-value">${employeeDetails.create_date}</div>
    </div>
    <div class="detail-row">
      <div class="detail-label">Last Updated:</div>
      <div class="detail-value">${employeeDetails.update_date}</div>
    </div>
  `;

      // Show the modal
      document.getElementById('employeeModal').style.display = 'block';
    }

    async function deleteEmployee() {
      if (!confirm("Are you sure you want to delete this employee?")) return;

      try {
        await fetch('API/employees.php', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'id=' + currentEmployeeId
        });

        // Close modal and refresh list
        document.getElementById('employeeModal').style.display = 'none';
        fetchEmployees();
      } catch (error) {
        console.error('Error deleting employee:', error);
      }
    }

    function searchEmployees() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const filteredEmployees = employees.filter(e =>
        e.name.toLowerCase().includes(searchTerm) ||
        (e.mobile_no && e.mobile_no.toLowerCase().includes(searchTerm))
      );
      renderTable(filteredEmployees);
    }

    function renderTable(list) {
      const tbody = document.getElementById('employeeTableBody');
      const totalCount = document.getElementById('totalCount');
      totalCount.textContent = `Total Employees: ${list.length}`;

      if (list.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state">
      <i class="fas fa-inbox"></i><h3>No employees found</h3></div></td></tr>`;
        return;
      }

      tbody.innerHTML = "";

      list.forEach((employee, i) => {
        const row = document.createElement('tr');
        // Add class for inactive employees
        if (employee.is_active == 0) {
          row.classList.add('inactive-employee');
        }

        // Get role name based on role_id
        let roleName = "Unknown";
        switch (employee.role_id) {
          case 1: roleName = "Admin"; break;
          case 2: roleName = "Manager"; break;
          case 3: roleName = "Staff"; break;
        }

        row.innerHTML = `
      <td>${i + 1}</td>
      <td>${employee.name} ${employee.is_active == 0 ? '(Inactive)' : ''}</td>
      <td>${employee.mobile_no || 'N/A'}</td>
      <td>
        <div class="actions">
          <button class="action-btn view" onclick="viewEmployee(${employee.id})">
            <i class="fas fa-eye"></i> View
          </button>
        </div>
      </td>`;
        tbody.appendChild(row);
      });
    }

    // Modal functionality
    const modal = document.getElementById('employeeModal');
    const span = document.getElementsByClassName('close')[0];

    span.onclick = function () {
      modal.style.display = 'none';
    }

    window.onclick = function (event) {
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }

    // Set up modal button handlers
    document.getElementById('modalEditBtn').addEventListener('click', function () {
      // Close the modal
      document.getElementById('employeeModal').style.display = 'none';

      // Find the employee in our existing data
      const employeeDetails = employees.find(e => e.id == currentEmployeeId);
      if (!employeeDetails) return;

      // Populate form with employee details
      document.getElementById('employeeNameInput').value = employeeDetails.name;
      document.getElementById('employeeMobileInput').value = employeeDetails.mobile_no;
      document.getElementById('employeeAddressInput').value = employeeDetails.address || '';

      // Set role and status
      document.getElementById('employeeRoleInput').value = employeeDetails.role_id;
      document.getElementById('employeeStatusInput').value = employeeDetails.is_active;

      // Change button text to indicate editing mode
      document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save"></i> Update Employee';

      // Set a global variable to track the employee being edited
      window.editingEmployeeId = currentEmployeeId;

      // Scroll to form
      document.querySelector('.employee-form').scrollIntoView({ behavior: 'smooth' });
    });

    document.getElementById('modalDeleteBtn').addEventListener('click', deleteEmployee);

    // Initialize
    document.getElementById('employeeNameInput').addEventListener('keypress', e => {
      if (e.key === 'Enter') saveEmployee();
    });

    fetchEmployees();
  </script>
</body>

</html>