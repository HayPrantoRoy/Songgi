<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style_css.css">
  <link rel="stylesheet" href="css/songgi-main-navbar.css">
  <link rel="stylesheet" href="css/suppliers.css">
  <title>Songgi - Suppliers</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
  <nav class="songgi-main-navbar">
    <div class="songgi-nav-left-section">
      <div class="songgi-app-branding">
        <div class="songgi-brand-title">Songgi</div>
      </div>
      <div class="songgi-balance-display" id="songgiBalanceToggle">
        <img class="songgi-balance-placeholder-text" src="img/account.png" width="20px">&nbsp;
        <span class="songgi-balance-placeholder-text">Super Admin</span>
      </div>
    </div>

    <div class="songgi-nav-right-section">
      <div class="songgi-nav-icon-btn" id="songgiNotificationCenter">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
          <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
        <div class="songgi-notification-counter">5</div>
      </div>
    </div>
  </nav>

  <!-- Suppliers Container -->
  <div class="suppliers-container">
    <!-- Add/Edit Form -->
    <div class="supplier-form">
      <div class="form-row">
        <input type="text" id="supplierNameInput" placeholder="Enter supplier name...">
        <input type="text" id="supplierMobileInput" placeholder="Enter mobile number...">
      </div>
      <div class="form-row">
        <input type="text" id="supplierAddressInput" placeholder="Enter address...">
        <!-- Add this dropdown for status -->
        <select id="supplierStatusInput">
          <option value="1">Active</option>
          <option value="0">Inactive</option>
        </select>
        <button id="saveBtn" onclick="saveSupplier()">
          <i class="fas fa-plus"></i>Add Supplier
        </button>
      </div>

      <!-- Stats Bar -->
      <div class="stats-bar">
        <div class="total-count" id="totalCount">Total Suppliers: 0</div>
        <input type="text" class="search-box" placeholder="Search suppliers..." id="searchInput"
          onkeyup="searchSuppliers()">
      </div>

      <!-- Data Table -->
      <div class="table-container">
        <table class="supplier-table">
          <thead>
            <tr>
              <th style="width: 60px;">ID</th>
              <th>Supplier Name</th>
              <th>Number</th>
              <th style="width: 100px;">Actions</th>
            </tr>
          </thead>
          <tbody id="supplierTableBody">
            <!-- Dynamic Rows -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Supplier Details Modal -->
    <div id="supplierModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2 class="modal-title">Supplier Details</h2>
        <div class="modal-details" id="modalDetails">
          <!-- Details will be populated here -->
        </div>
        <div class="modal-actions">
          <button class="modal-btn edit" id="modalEditBtn">Edit</button>
          <button class="modal-btn delete" id="modalDeleteBtn">Delete</button>
        </div>
      </div>
    </div>

    <!-- Navigation Bar -->
    <div class="navbar">
      <div class="nav-item active" data-page="home">
        <i class="nav-icon fas fa-home"></i>
      </div>

      <div class="nav-item" data-page="history">
        <i class="nav-icon fas fa-chart-bar"></i>
      </div>

      <div class="nav-item" data-page="profile">
        <i class="nav-icon fas fa-user"></i>
      </div>
    </div>
    <script>
      let suppliers = [];
      let currentSupplierId = null;

      async function fetchSuppliers() {
        try {
          const res = await fetch('API/suppliers.php');
          suppliers = await res.json();
          renderTable(suppliers);
        } catch (error) {
          console.error('Error fetching suppliers:', error);
        }
      }

      async function saveSupplier() {
        const nameInput = document.getElementById('supplierNameInput');
        const mobileInput = document.getElementById('supplierMobileInput');
        const addressInput = document.getElementById('supplierAddressInput');
        const statusInput = document.getElementById('supplierStatusInput');

        const name = nameInput.value.trim();
        const mobile_no = mobileInput.value.trim();
        const address = addressInput.value.trim();
        const is_active = parseInt(statusInput.value);

        if (!name || !mobile_no) {
          alert('Please enter supplier name and mobile number');
          return;
        }

        try {
          const isEditing = window.editingSupplierId !== undefined;
          const url = 'API/suppliers.php';
          const method = isEditing ? 'PUT' : 'POST';
          const body = isEditing ?
            JSON.stringify({ id: window.editingSupplierId, name, mobile_no, address, is_active }) :
            JSON.stringify({ name, mobile_no, address, is_active });

          await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: body
          });

          // Clear inputs and reset form
          nameInput.value = "";
          mobileInput.value = "";
          addressInput.value = "";
          statusInput.value = "1";

          // Reset button text if we were editing
          if (isEditing) {
            document.getElementById('saveBtn').innerHTML = '<i class="fas fa-plus"></i> Add Supplier';
            window.editingSupplierId = undefined;
          }

          // Refresh the list
          fetchSuppliers();
        } catch (error) {
          console.error('Error saving supplier:', error);
        }
      }

      function viewSupplier(id) {
        const supplier = suppliers.find(s => s.id == id);
        if (!supplier) return;

        currentSupplierId = id;

        // Use the existing suppliers data instead of making another API call
        const supplierDetails = supplier;

        // Populate modal with details
        const modalDetails = document.getElementById('modalDetails');
        modalDetails.innerHTML = `
    <div class="detail-row">
      <div class="detail-label">Name:</div>
      <div class="detail-value">${supplierDetails.name}</div>
    </div>
    <div class="detail-row">
      <div class="detail-label">Mobile:</div>
      <div class="detail-value">${supplierDetails.mobile_no || 'N/A'}</div>
    </div>
    <div class="detail-row">
      <div class="detail-label">Address:</div>
      <div class="detail-value">${supplierDetails.address || 'N/A'}</div>
    </div>
    <div class="detail-row">
      <div class="detail-label">Status:</div>
      <div class="detail-value">${supplierDetails.is_active == 1 ? 'Active' : 'Inactive'}</div>
    </div>
    <div class="detail-row">
      <div class="detail-label">Created:</div>
      <div class="detail-value">${supplierDetails.create_date}</div>
    </div>
    <div class="detail-row">
      <div class="detail-label">Last Updated:</div>
      <div class="detail-value">${supplierDetails.update_date}</div>
    </div>
  `;

        // Show the modal
        document.getElementById('supplierModal').style.display = 'block';
      }

      async function deleteSupplier() {
        if (!confirm("Are you sure you want to delete this supplier?")) return;

        try {
          await fetch('API/suppliers.php', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'id=' + currentSupplierId
          });

          // Close modal and refresh list
          document.getElementById('supplierModal').style.display = 'none';
          fetchSuppliers();
        } catch (error) {
          console.error('Error deleting supplier:', error);
        }
      }

      function searchSuppliers() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const filteredSuppliers = suppliers.filter(s =>
          s.name.toLowerCase().includes(searchTerm) ||
          (s.mobile_no && s.mobile_no.toLowerCase().includes(searchTerm))
        );
        renderTable(filteredSuppliers);
      }

      function renderTable(list) {
        const tbody = document.getElementById('supplierTableBody');
        const totalCount = document.getElementById('totalCount');
        totalCount.textContent = `Total Suppliers: ${list.length}`;

        if (list.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4"><div class="empty-state">
      <i class="fas fa-inbox"></i><h3>No suppliers found</h3></div></td></tr>`;
          return;
        }

        tbody.innerHTML = "";

        list.forEach((supplier, i) => {
          const row = document.createElement('tr');
          // Add class for inactive suppliers
          if (supplier.is_active == 0) {
            row.classList.add('inactive-supplier');
          }

          row.innerHTML = `
      <td>${i + 1}</td>
      <td>${supplier.name} ${supplier.is_active == 0 ? '(Inactive)' : ''}</td>
      <td>${supplier.mobile_no || 'N/A'}</td>
      <td>
        <div class="actions">
          <button class="action-btn view" onclick="viewSupplier(${supplier.id})">
            <i class="fas fa-eye"></i> View
          </button>
        </div>
      </td>`;
          tbody.appendChild(row);
        });
      }

      // Modal functionality
      const modal = document.getElementById('supplierModal');
      const span = document.getElementsByClassName('close')[0];

      span.onclick = function () {
        modal.style.display = 'none';
      }

      window.onclick = function (event) {
        if (event.target == modal) {
          modal.style.display = 'none';
        }
      }

      // Set up modal button handlers
      document.getElementById('modalEditBtn').addEventListener('click', function () {
        // Close the modal
        document.getElementById('supplierModal').style.display = 'none';

        // Find the supplier in our existing data
        const supplierDetails = suppliers.find(s => s.id == currentSupplierId);
        if (!supplierDetails) return;

        // Populate form with supplier details
        document.getElementById('supplierNameInput').value = supplierDetails.name;
        document.getElementById('supplierMobileInput').value = supplierDetails.mobile_no;
        document.getElementById('supplierAddressInput').value = supplierDetails.address || '';

        // Set status
        document.getElementById('supplierStatusInput').value = supplierDetails.is_active;

        // Change button text to indicate editing mode
        document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save"></i> Update Supplier';

        // Set a global variable to track the supplier being edited
        window.editingSupplierId = currentSupplierId;

        // Scroll to form
        document.querySelector('.supplier-form').scrollIntoView({ behavior: 'smooth' });
      });

      document.getElementById('modalDeleteBtn').addEventListener('click', deleteSupplier);

      // Initialize
      document.getElementById('supplierNameInput').addEventListener('keypress', e => {
        if (e.key === 'Enter') saveSupplier();
      });

      fetchSuppliers();
    </script>
</body>

</html>