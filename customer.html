<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style_css.css">
  <link rel="stylesheet" href="css/songgi-main-navbar.css">
  <title>Songgi - Customers</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/customer.css">
</head>

<body>
  <nav class="songgi-main-navbar">
    <div class="songgi-nav-left-section">
      <div class="songgi-app-branding">
        <div class="songgi-brand-title">Songgi</div>
      </div>
      <div class="songgi-balance-display" id="songgiBalanceToggle">
        <img class="songgi-balance-placeholder-text" src="img/account.png" width="20px">&nbsp;
        <span class="songgi-balance-placeholder-text">Super Admin</span>
      </div>
    </div>

    <div class="songgi-nav-right-section">
      <div class="songgi-nav-icon-btn" id="songgiNotificationCenter">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
          <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
        <div class="songgi-notification-counter">5</div>
      </div>
    </div>
  </nav>

  <!-- Customers Container -->
  <div class="customers-container">
    <!-- Add/Edit Form -->
    <div class="customer-form">
      <div class="form-row">
        <input type="text" id="customerNameInput" placeholder="Enter customer name...">
        <input type="text" id="customerMobileInput" placeholder="Enter mobile number...">
      </div>
      <div class="form-row">
        <input type="text" id="customerAddressInput" placeholder="Enter address...">
        <select id="customerStatusInput">
          <option value="1">Active</option>
          <option value="0">Inactive</option>
        </select>
        <button id="saveBtn" onclick="saveCustomer()">
          <i class="fas fa-plus"></i>Add Customer
        </button>
      </div>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
      <div class="total-count" id="totalCount">Total Customers: 0</div>
      <input type="text" class="search-box" placeholder="Search customers..." id="searchInput"
        onkeyup="searchCustomers()">
    </div>

    <!-- Data Table -->
    <div class="table-container">
      <table class="customer-table">
        <thead>
          <tr>
            <th style="width: 60px;">ID</th>
            <th>Customer Name</th>
            <th>Number</th>
            <th style="width: 100px;">Actions</th>
          </tr>
        </thead>
        <tbody id="customerTableBody">
          <!-- Dynamic Rows -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Customer Details Modal -->
  <div id="customerModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 class="modal-title">Customer Details</h2>
      <div class="modal-details" id="modalDetails">
        <!-- Details will be populated here -->
      </div>
      <div class="modal-actions">
        <button class="modal-btn edit" id="modalEditBtn">Edit</button>
        <button class="modal-btn delete" id="modalDeleteBtn">Delete</button>
      </div>
    </div>
  </div>

  <!-- Navigation Bar -->
  <div class="navbar">
      <div class="nav-item" data-page="home">
      <a href="index.html"><i class="nav-icon fas fa-home"></i></a>  
      </div>

      <div class="nav-item" data-page="history">
        <i class="nav-icon fas fa-chart-bar"></i>
      </div>

      <div class="nav-item" data-page="profile">
        <i class="nav-icon fas fa-user"></i>
      </div>
    </div>
  <script>
    let customers = [];
    let currentCustomerId = null;

    async function fetchCustomers() {
      try {
        const res = await fetch('API/customers.php');
        customers = await res.json();
        renderTable(customers);
      } catch (error) {
        console.error('Error fetching customers:', error);
      }
    }

    async function saveCustomer() {
      const nameInput = document.getElementById('customerNameInput');
      const mobileInput = document.getElementById('customerMobileInput');
      const addressInput = document.getElementById('customerAddressInput');
      const statusInput = document.getElementById('customerStatusInput');

      const name = nameInput.value.trim();
      const mobile_no = mobileInput.value.trim();
      const address = addressInput.value.trim();
      const is_active = parseInt(statusInput.value);

      if (!name || !mobile_no) {
        alert('Please enter customer name and mobile number');
        return;
      }

      try {
        const isEditing = window.editingCustomerId !== undefined;
        const url = 'API/customers.php';
        const method = isEditing ? 'PUT' : 'POST';
        const body = isEditing ?
          JSON.stringify({ id: window.editingCustomerId, name, mobile_no, address, is_active }) :
          JSON.stringify({ name, mobile_no, address, is_active });

        await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: body
        });

        // Clear inputs and reset form
        nameInput.value = "";
        mobileInput.value = "";
        addressInput.value = "";
        statusInput.value = "1";

        // Reset button text if we were editing
        if (isEditing) {
          document.getElementById('saveBtn').innerHTML = '<i class="fas fa-plus"></i> Add Customer';
          window.editingCustomerId = undefined;
        }

        // Refresh the list
        fetchCustomers();
      } catch (error) {
        console.error('Error saving customer:', error);
      }
    }

    function viewCustomer(id) {
      const customer = customers.find(c => c.id == id);
      if (!customer) return;

      currentCustomerId = id;

      // Use the existing customers data instead of making another API call
      const customerDetails = customer;

      // Populate modal with details
      const modalDetails = document.getElementById('modalDetails');
      modalDetails.innerHTML = `
    <div class="detail-row">
      <div class="detail-label">Name:</div>
      <div class="detail-value">${customerDetails.name}</div>
    </div>
    <div class="detail-row">
      <div class="detail-label">Mobile:</div>
      <div class="detail-value">${customerDetails.mobile_no || 'N/A'}</div>
    </div>
    <div class="detail-row">
      <div class="detail-label">Address:</div>
      <div class="detail-value">${customerDetails.address || 'N/A'}</div>
    </div>
    <div class="detail-row">
      <div class="detail-label">Status:</div>
      <div class="detail-value">${customerDetails.is_active == 1 ? 'Active' : 'Inactive'}</div>
    </div>
    <div class="detail-row">
      <div class="detail-label">Created:</div>
      <div class="detail-value">${customerDetails.create_date}</div>
    </div>
    <div class="detail-row">
      <div class="detail-label">Last Updated:</div>
      <div class="detail-value">${customerDetails.update_date}</div>
    </div>
  `;

      // Show the modal
      document.getElementById('customerModal').style.display = 'block';
    }

    async function deleteCustomer() {
      if (!confirm("Are you sure you want to delete this customer?")) return;

      try {
        await fetch('API/customers.php', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'id=' + currentCustomerId
        });

        // Close modal and refresh list
        document.getElementById('customerModal').style.display = 'none';
        fetchCustomers();
      } catch (error) {
        console.error('Error deleting customer:', error);
      }
    }

    function searchCustomers() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const filteredCustomers = customers.filter(c =>
        c.name.toLowerCase().includes(searchTerm) ||
        (c.mobile_no && c.mobile_no.toLowerCase().includes(searchTerm))
      );
      renderTable(filteredCustomers);
    }

    function renderTable(list) {
      const tbody = document.getElementById('customerTableBody');
      const totalCount = document.getElementById('totalCount');
      totalCount.textContent = `Total Customers: ${list.length}`;

      if (list.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4"><div class="empty-state">
      <i class="fas fa-inbox"></i><h3>No customers found</h3></div></td></tr>`;
        return;
      }

      tbody.innerHTML = "";

      list.forEach((customer, i) => {
        const row = document.createElement('tr');
        // Add class for inactive customers
        if (customer.is_active == 0) {
          row.classList.add('inactive-customer');
        }

        row.innerHTML = `
      <td>${i + 1}</td>
      <td>${customer.name} ${customer.is_active == 0 ? '(Inactive)' : ''}</td>
      <td>${customer.mobile_no || 'N/A'}</td>
      <td>
        <div class="actions">
          <button class="action-btn view" onclick="viewCustomer(${customer.id})">
            <i class="fas fa-eye"></i> View
          </button>
        </div>
      </td>`;
        tbody.appendChild(row);
      });
    }

    // Modal functionality
    const modal = document.getElementById('customerModal');
    const span = document.getElementsByClassName('close')[0];

    span.onclick = function () {
      modal.style.display = 'none';
    }

    window.onclick = function (event) {
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }

    // Set up modal button handlers
    document.getElementById('modalEditBtn').addEventListener('click', function () {
      // Close the modal
      document.getElementById('customerModal').style.display = 'none';

      // Find the customer in our existing data
      const customerDetails = customers.find(c => c.id == currentCustomerId);
      if (!customerDetails) return;

      // Populate form with customer details
      document.getElementById('customerNameInput').value = customerDetails.name;
      document.getElementById('customerMobileInput').value = customerDetails.mobile_no;
      document.getElementById('customerAddressInput').value = customerDetails.address || '';

      // Set status
      document.getElementById('customerStatusInput').value = customerDetails.is_active;

      // Change button text to indicate editing mode
      document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save"></i> Update Customer';

      // Set a global variable to track the customer being edited
      window.editingCustomerId = currentCustomerId;

      // Scroll to form
      document.querySelector('.customer-form').scrollIntoView({ behavior: 'smooth' });
    });

    document.getElementById('modalDeleteBtn').addEventListener('click', deleteCustomer);

    // Initialize
    document.getElementById('customerNameInput').addEventListener('keypress', e => {
      if (e.key === 'Enter') saveCustomer();
    });

    fetchCustomers();
  </script>
</body>

</html>